
name: ScanCode copyrights/authors (Docker, paged & parallel)

on:
  workflow_dispatch:
    inputs:
      components_file:
        description: "Path to input components JSON (from previous step)"
        default: "components.json"
        required: true
        type: string
      page_size:
        description: "How many components to scan in parallel (page size)"
        default: 8
        required: true
        type: number
      scan_options:
        description: "ScanCode options (space-separated)"
        default: "--copyright --info"
        required: true
        type: string

jobs:
  # 1) Prepare a dynamic matrix of components that have a Git URL
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build.outputs.matrix }}
      count: ${{ steps.count.outputs.count }}
    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      - name: Read input components and build dynamic matrix
        id: build
        shell: bash
        run: |
          set -e
          INPUT="${{ github.event.inputs.components_file }}"
          # Filter components with a non-empty Url; keep all fields for later
          MATRIX=$(jq -c '[ .[] | { 
              Component: .Component, 
              Url: .Url, 
              version: .version, 
              license: .license, 
              SNo: (."S.No") 
            } ]' "$INPUT")
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

      - name: Count components
        id: count
        run: |
          INPUT="${{ github.event.inputs.components_file }}"
          COUNT=$(jq 'length' "$INPUT")
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

  # 2) Build the ScanCode Docker image from the official repo Dockerfile
  build-image:
    runs-on: ubuntu-latest
    needs: prepare-matrix
    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      - name: Clone ScanCode Toolkit (official)
        run: |
          git clone --depth=1 https://github.com/aboutcode-org/scancode-toolkit.git
        # Docs: build from the included Dockerfile
        # Ref: Comprehensive install & Docker path (official docs) [2](https://scancode-toolkit.readthedocs.io/en/latest/getting-started/install.html)[3](https://github.com/aboutcode-org/scancode-toolkit/blob/develop/docs/source/getting-started/install.rst)

      - name: Build Docker image
        run: |
          docker build -t scancode:latest scancode-toolkit

  # 3) Fan-out: one job per component (parallel limited by page_size)
  scan-component:
    runs-on: ubuntu-latest
    needs: [prepare-matrix, build-image]
    strategy:
      fail-fast: false
      # "Pages" => limit concurrent component scans to page_size
      max-parallel: ${{ github.event.inputs.page_size }}
      matrix:
        include: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      - name: Clone target repository (depth=1)
        if: ${{ matrix.Url != '' }}
        shell: bash
        run: |
          set -e
          git clone --depth=1 "${{ matrix.Url }}" repo || {
            echo "::warning::Clone failed for ${{ matrix.Url }}"; 
            mkdir -p repo; 
          }

      - name: Run ScanCode in Docker (copyrights/authors)
        shell: bash
        run: |
          set -e
          mkdir -p out
          # Run ScanCode; options are configurable via workflow input
          docker run --rm -v "$PWD/repo":/scan scancode:latest \
            ${{ github.event.inputs.scan_options }} \
            --json-pp /scan_output.json /scan || true
          # Extract aggregated copyrights/authors and create enriched component JSON
          python - <<'PY'
          import json, os
          comp = {
            "Component": os.environ.get("COMPONENT"),
            "version": os.environ.get("VERSION"),
            "Url": os.environ.get("URL"),
            "license": os.environ.get("LICENSE"),
            "S.No": int(os.environ.get("SNO", "0")),
          }
          copyrights, authors = set(), set()
          path = "/scan_output.json"
          if os.path.exists(path):
            with open(path, "r", encoding="utf-8") as f:
              data = json.load(f)
            # ScanCode JSON typically contains a "files" list with per-file detections
            # We consolidate unique values across all files
            for fi in data.get("files", []):
              for c in fi.get("copyrights", []):
                val = c.get("value") or c.get("copyright") or ""
                if val.strip(): copyrights.add(val.strip())
              for a in fi.get("authors", []):
                val = a.get("value") or a.get("author") or ""
                if val.strip(): authors.add(val.strip())
          comp["copyrights"] = sorted(copyrights)
          comp["authors"] = sorted(authors)
          os.makedirs("out", exist_ok=True)
          out_file = f'out/component-{comp["S.No"]}.json'
          with open(out_file, "w", encoding="utf-8") as f:
            json.dump(comp, f, indent=2)
          PY
        env:
          COMPONENT: ${{ matrix.Component }}
          VERSION:   ${{ matrix.version }}
          URL:       ${{ matrix.Url }}
          LICENSE:   ${{ matrix.license }}
          SNO:       ${{ matrix.SNo }}
        # CLI options: copyrights (and authors) are detected with --copyright; see ScanCode docs. [1](https://scancode-toolkit.readthedocs.io/en/latest/tutorials/how_to_set_what_will_be_detected_in_a_scan.html)[11](https://scancode-toolkit.readthedocs.io/en/stable/getting-started/home.html)

      - name: Upload per-component artifact (immediately available with v4)
        uses: actions/upload-artifact@v4
        with:
          # Make artifact discoverable per component
          name: component-${{ matrix.SNo }}-${{ matrix.Component }}
          path: out
        # Artifacts v4 are job-scoped & immediately downloadable; use v4. [8](https://github.blog/changelog/2023-12-14-github-actions-artifacts-v4-is-now-generally-available/)[9](https://github.com/actions/upload-artifact)

  # 4) Aggregate all component outputs into a single enriched JSON
  aggregate:
    runs-on: ubuntu-latest
    needs: scan-component
    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      - name: Download all component artifacts (v4 pattern + merge)
        uses: actions/download-artifact@v4
        with:
          pattern: component-*
          merge-multiple: true
        # Pattern + merge-multiple are v4 features for efficient aggregation. [8](https://github.blog/changelog/2023-12-14-github-actions-artifacts-v4-is-now-generally-available/)

      - name: Merge back into original list (preserve order, add fields)
        id: merge
        shell: bash
        run: |
          set -e
          INPUT="${{ github.event.inputs.components_file }}"
          COUNT="${{ needs.prepare-matrix.outputs.count }}"
          python - <<'PY'
          import json, glob, os, sys
          inp = os.environ["INPUT"]
          with open(inp, "r", encoding="utf-8") as f:
            components = json.load(f)
          # Index artifacts by S.No
          enriched = {}
          for path in glob.glob("**/component-*.json", recursive=True):
            with open(path, "r", encoding="utf-8") as f:
              obj = json.load(f)
              enriched[obj["S.No"]] = obj
          # Merge into original sequence, add fields if available
          out = []
          for item in components:
            sno = item.get("S.No")
            add = enriched.get(sno, {})
            merged = dict(item)
            merged["copyrights"] = add.get("copyrights", [])
            merged["authors"]    = add.get("authors", [])
            out.append(merged)
          # Name the final file with count appended
          base, ext = os.path.splitext(inp)
          final_name = f"{base}-with-copyrights-{len(out)}{ext or '.json'}"
          with open(final_name, "w", encoding="utf-8") as f:
            json.dump(out, f, indent=2)
          print(final_name)
          PY
        env:
          INPUT: ${{ github.event.inputs.components_file }}

      - name: Upload aggregated JSON
        uses: actions/upload-artifact@v4
        with:
          name: components-with-copyrights
